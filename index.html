<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diriyah Brain AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{
      --bg:#F5F2E9; --panel:#FFFFFF; --border:#E6DDCD; --ink:#1F1C17; --muted:#6F675B;
      --ai:#EFE6D6; --user:#D7E3FF; --accent:#B8895A; --accent-2:#A07A50;
      --alert:#FEE2E2; --alert-border:#FCA5A5;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;font-family:'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:var(--bg);color:var(--ink);
      display:grid;grid-template-columns:240px 1fr;grid-template-rows:64px 1fr;
      grid-template-areas:"topbar topbar" "sidebar main";
    }
    .topbar{grid-area:topbar;background:linear-gradient(180deg,#E9DCC9,#DECCB4);
      border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;}
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{width:56px;height:56px;border-radius:50%;object-fit:cover;background:#d9cdb7;}
    .title{font-weight:600;font-size:1.1rem;}
    .sidebar{
      grid-area:sidebar;background:#F0E9DC;border-right:1px solid var(--border);
      padding:12px;display:flex;flex-direction:column;gap:8px;
    }
    .sidebar button{all:unset;padding:10px 12px;border-radius:8px;background:#fff;border:1px solid var(--border);
      cursor:pointer;font-weight:500;text-align:left;}
    .sidebar button:hover{background:#fdfaf5;}
    .sidebar select{width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:#fff;font-size:14px;}
    .main{grid-area:main;display:flex;flex-direction:column;}
    .chat{flex:1;overflow-y:auto;padding:16px;}
    .row{display:flex;margin:8px 0;}
    .msg{max-width:70%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);line-height:1.5;font-size:15px;white-space:pre-wrap;}
    .user{margin-left:auto;background:var(--user);}
    .ai{background:var(--ai);}
    .alert{background:var(--alert);border:1px solid var(--alert-border);}
    .composer{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;background:var(--panel);}
    .composer input{flex:1;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:15px;}
    .send,.quiet{display:flex;align-items:center;justify-content:center;width:42px;height:42px;border-radius:50%;border:none;cursor:pointer;font-size:18px;}
    .send{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;}
    .quiet{background:#fff;border:1px solid var(--border);color:var(--ink);}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img class="logo" src="static/logo.png" alt="Diriyah Brain AI logo">
      <div class="title">Diriyah Brain AI</div>
    </div>
  </header>

  <aside class="sidebar">
    <button onclick="newChat()">+ New Chat</button>
    <button onclick="exportChat()">üíæ Export PDF</button>
    <button onclick="refreshNow()">üîÑ Refresh Now</button>
    <div>
      <label for="projectSelect">üìÇ Project:</label>
      <select id="projectSelect" onchange="switchProject()"></select>
    </div>
    <div id="lastUpdate" title="Never refreshed">üóÇÔ∏è Last update</div>
  </aside>

  <main class="main">
    <div id="chat" class="chat">
      <div class="row"><div class="msg ai">‚úÖ Connected. Please select a project and ask in English or Arabic.</div></div>
    </div>
    <div class="composer">
      <button class="quiet" id="micBtn" title="Voice"><i class="fa-solid fa-microphone"></i></button>
      <input id="q" type="text" placeholder="Ask‚Ä¶ (BOQ, schedules, insurances, RFIs)">
      <button class="send" id="send"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  </main>

  <script>
    const chat = document.getElementById('chat');
    const qInput = document.getElementById('q');
    const sendBtn = document.getElementById('send');
    const projectSelect = document.getElementById('projectSelect');
    const lastUpdateEl = document.getElementById('lastUpdate');
    let history = [];

    // Load projects on startup
    async function loadProjects(){
      try{
        const r = await fetch('/projects/list');
        const j = await r.json();
        const names = j.projects || [];
        projectSelect.innerHTML = '';
        names.forEach((name, idx) => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          projectSelect.appendChild(opt);
        });
        if(names.length){
          projectSelect.value = names[0];
          await switchProject();
        }
      } catch(err){
        console.error(err);
      }
    }

    async function switchProject(){
      const proj = projectSelect.value;
      if(!proj) return;
      // Reset chat and history
      chat.innerHTML = '';
      history = [];
      addMsg('ai', `Switched to ${proj}. Ask your question.`);
      // Notify server of project switch
      await fetch('/projects/switch', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ project: proj }) });
      await getLastUpdate();
    }

    async function getLastUpdate(){
      const proj = projectSelect.value;
      try{
        const r = await fetch(`/drive/last-update?project=${encodeURIComponent(proj)}`);
        const j = await r.json();
        if(j.timestamp){
          lastUpdateEl.title = `Last update: ${new Date(j.timestamp).toLocaleString()}`;
        }
      } catch(err){ console.error(err); }
    }

    async function sendQuery(){
      const query = qInput.value.trim();
      if(!query) return;
      const proj = projectSelect.value;
      addMsg('user', query);
      qInput.value = '';
      const fd = new FormData();
      fd.append('query', query);
      fd.append('role', getRole());
      fd.append('project', proj);
      try{
        const r = await fetch('/ai/query', { method:'POST', body: fd });
        const j = await r.json();
        if(j.alerts){
          j.alerts.forEach(a => addAlert(a.message));
        }
        addMsg('ai', j.reply || '(no reply)');
      } catch(err){
        addMsg('ai', 'Error: '+err.message);
      }
    }
    sendBtn.addEventListener('click', sendQuery);
    qInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') sendQuery(); });

    // Role selection based on user login; for demo, infer from URL param or default to engineer
    function getRole(){
      const params = new URLSearchParams(window.location.search);
      return params.get('role') || 'engineer';
    }

    function addMsg(role, text, cls=''){
      const row = document.createElement('div');
      row.className = 'row';
      const bubble = document.createElement('div');
      bubble.className = 'msg '+(role==='user'?'user':'ai')+(cls?(' '+cls):'');
      bubble.textContent = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      history.push({ role, text });
    }
    function addAlert(text){ addMsg('ai', '‚ö†Ô∏è '+text, 'alert'); }

    async function refreshNow(){
      const proj = projectSelect.value;
      addMsg('ai', '‚è≥ Refreshing project documents‚Ä¶');
      try{
        const r = await fetch(`/drive/refresh?project=${encodeURIComponent(proj)}`, { method:'POST' });
        const j = await r.json();
        addMsg('ai', j.message || 'Refresh complete');
        if(j.timestamp){
          lastUpdateEl.title = `Last update: ${new Date(j.timestamp).toLocaleString()}`;
        }
      } catch(err){
        addMsg('ai', 'Error: '+err.message);
      }
    }

    function newChat(){
      chat.innerHTML = '';
      history = [];
      addMsg('ai', 'New chat started.');
    }

    async function exportChat(){
      const proj = projectSelect.value;
      try{
        const resp = await fetch('/chat/export/pdf', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(history)
        });
        if(!resp.ok){ throw new Error('Export failed'); }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat_${proj}.pdf`;
        a.click();
      } catch(err){ addMsg('ai', 'Export error: '+err.message); }
    }

    // Voice recognition (Arabic by default)
    const micBtn = document.getElementById('micBtn');
    micBtn.addEventListener('click', () => {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ alert('Speech recognition not supported'); return; }
      const rec = new SR();
      rec.lang = 'ar-SA';
      rec.onresult = (e) => {
        qInput.value = e.results[0][0].transcript;
        sendQuery();
      };
      rec.start();
    });

    window.addEventListener('load', loadProjects);
  </script>
</body>
</html>