<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Diriyah AI</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* ===== Diriyah palette inspired by the photo =====
     Sand        #D9C3A3
     Clay/Amber  #BC8A5F
     Terracotta  #9C5E2C
     Dates Brown #4A3626
     Palm Green  #2E5E3E (sparingly)
     Off-White   #F6EFE5
  */
  :root{
    --sand:#D9C3A3;
    --clay:#BC8A5F;
    --terracotta:#9C5E2C;
    --brown:#4A3626;
    --green:#2E5E3E;
    --off:#F6EFE5;

    --bg: #1f1a16;           /* deep background for contrast */
    --panel:#241E19;         /* panels */
    --card:#2C241E;          /* cards */
    --border:#3A2F26;
    --text:#F6EFE5;
    --mut:#CBBBA6;
    --accent:#BC8A5F;        /* clay */
    --accent2:#9C5E2C;       /* terracotta */
    --ok:#2E5E3E;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .arabic{font-family:"Tajawal", system-ui, sans-serif}

  .app{max-width:1200px;margin:0 auto;padding:20px}
  .header{
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border:1px solid #824b21;
    border-radius:16px;
    padding:16px 18px;
    display:flex;align-items:center;justify-content:space-between;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .brand-title{display:flex;flex-direction:column;line-height:1.1}
  .brand .logo{width:44px;height:44px;border-radius:999px;background:var(--off);
               display:flex;align-items:center;justify-content:center;border:2px solid var(--terracotta);}
  .brand .title-en{font-weight:800;font-size:20px}
  .brand .title-ar{font-weight:700;font-size:12px;opacity:.9}

  .pill{background:rgba(255,255,255,.18);padding:8px 12px;border-radius:999px;display:flex;gap:8px;align-items:center;font-weight:700}
  .pill.ok{background:rgba(46,94,62,.25)}

  .layout{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:16px}
  @media (max-width: 920px){ .layout{grid-template-columns:1fr} }

  /* Left column */
  .left{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  h2{font-size:16px;margin:8px 0 10px}
  .svc{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);
       border-radius:12px;padding:12px;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.15)}
  .svc + .svc{margin-top:10px}
  .svc .ico{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#201A15;color:var(--sand)}
  .svc .meta{line-height:1.2}
  .svc .meta .t{font-weight:700}
  .svc .meta .s{color:var(--mut);font-size:12px;margin-top:2px}
  .svc.active{outline:2px solid var(--accent)}
  .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:10px;padding:10px 12px;
       background:var(--ok);color:#e7f3ea;font-weight:800;cursor:pointer}
  .btn.gray{background:#3A2F26;color:#E5D8C6}
  .sep{height:1px;background:var(--border);margin:16px 0}

  .proj-list{display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow:auto}
  .proj{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer;text-align:left;color:var(--off)}
  .proj:hover{border-color:#6e4a2a}
  .proj.active{outline:2px solid var(--accent)}
  .mut{color:var(--mut);font-size:12px}

  /* Right column (chat) */
  .right{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;display:flex;flex-direction:column;height:calc(80vh - 16px)}
  .chat{flex:1;overflow:auto;background:#1b1612;border:1px solid var(--border);border-radius:10px;padding:12px;
        background-image: radial-gradient(circle at 12px 12px, rgba(188,138,95,.08) 2px, transparent 2px);
        background-size: 24px 24px;}
  .msg{max-width:85%;padding:10px 12px;border-radius:10px;margin:8px 0;white-space:pre-wrap;line-height:1.55}
  .me{background:#3A2F26;margin-left:auto;border:1px solid #6e4a2a}
  .ai{background:#2C241E;border:1px solid #6e4a2a}
  .composer{display:flex;gap:10px;margin-top:12px}
  textarea{flex:1;min-height:52px;resize:vertical;border-radius:10px;border:1px solid var(--border);
           background:#1b1612;color:var(--off);padding:10px}
  .ask{background:var(--terracotta);color:#fff;border:none;border-radius:10px;padding:0 16px;font-weight:800}
  a{color:#F6C68C}
</style>
</head>
<body>
<div class="app">
  <div class="header" role="banner">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <!-- Simple geometric logo echoing Diriyah roundel (replace with your official SVG/PNG if you have it) -->
        <svg width="30" height="30" viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="47" fill="none" stroke="#9C5E2C" stroke-width="6"></circle>
          <path d="M20 60 Q35 40 50 55 T80 50 V78 H20 Z" fill="#BC8A5F" stroke="#9C5E2C" stroke-width="2"/>
          <g stroke="#9C5E2C" stroke-width="2">
            <line x1="22" y1="78" x2="78" y2="78"/>
            <line x1="25" y1="84" x2="75" y2="84"/>
          </g>
        </svg>
      </div>
      <div class="brand-title">
        <div class="title-en">Diriyah AI</div>
        <div class="arabic title-ar">الدرعية للذكاء الاصطناعي</div>
      </div>
    </div>
    <div id="cloud-pill" class="pill ok"><i class="fa-solid fa-cloud"></i> Connected to Cloud Storage</div>
  </div>

  <div class="layout">
    <!-- LEFT: Cloud & Projects -->
    <aside class="left" aria-label="Sidebar">
      <h2>Cloud Services</h2>
      <div id="gsvc" class="svc active" onclick="openUrl(API_BASE + '/auth/google/start')">
        <div class="ico"><i class="fa-brands fa-google-drive"></i></div>
        <div class="meta">
          <div class="t">Google Drive</div>
          <div class="s" id="gsvc-status">Connected to project files</div>
        </div>
      </div>
      <div id="msvc" class="svc" onclick="openUrl(API_BASE + '/auth/ms/start')">
        <div class="ico"><i class="fa-brands fa-microsoft"></i></div>
        <div class="meta">
          <div class="t">OneDrive</div>
          <div class="s" id="msvc-status">Connect to Microsoft OneDrive</div>
        </div>
      </div>

      <div class="sep"></div>

      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2 style="margin:0">Projects</h2>
        <button class="btn gray" onclick="refreshProjects()"><i class="fa-solid fa-rotate"></i> Refresh</button>
      </div>
      <div id="projList" class="proj-list" aria-live="polite">
        <div class="mut">No mapped projects yet. POST <code>/projects/folders</code> to add.</div>
      </div>

      <div class="sep"></div>
      <div class="mut">
        Tip: Click a project to scope searches to its folder.<br/>
        Add mappings via <code>POST /projects/folders</code>.
      </div>
    </aside>

    <!-- RIGHT: Chat -->
    <main class="right" aria-label="Chat">
      <div id="chat" class="chat" aria-live="polite"></div>
      <div class="composer">
        <textarea id="q" placeholder="اكتب سؤالك هنا…  •  Ask a question and I’ll include direct links to sources."></textarea>
        <button class="ask" id="send"><i class="fa-solid fa-paper-plane"></i> Ask</button>
      </div>
      <div class="mut" style="margin-top:6px">
        Connect: <a href="#" onclick="openUrl(API_BASE + '/auth/google/start')">Google Drive</a> ·
        <a href="#" onclick="openUrl(API_BASE + '/auth/ms/start')">OneDrive</a>
      </div>
    </main>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const API_BASE = 'https://YOUR-BACKEND.onrender.com'; // <-- set to your backend URL // change if your FastAPI is elsewhere
const AI_ENDPOINT = API_BASE + '/ai/query';
const MAP_ENDPOINT = API_BASE + '/projects/folders';

/* ====== STATE ====== */
let activeProject = null; // {project_name, provider, folder_id, display_name}

/* ====== HELPERS ====== */
const chat = document.getElementById('chat');
const q = document.getElementById('q');
const send = document.getElementById('send');
const projList = document.getElementById('projList');

function openUrl(u){ window.open(u, '_self'); }
function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function md(s){
  const safe = esc(s).replace(/^(\s*[-*]\s+)/gm,'• ').replace(/\n{3,}/g,'\n\n');
  return safe.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
}
function addMsg(txt, who='ai'){
  const div = document.createElement('div');
  div.className = 'msg ' + (who === 'me' ? 'me' : 'ai');
  div.innerHTML = md(txt);
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ====== PROJECTS ====== */
async function refreshProjects(){
  try{
    const res = await fetch(MAP_ENDPOINT);
    const data = await res.json();
    projList.innerHTML = '';
    const keys = Object.keys(data);
    if (!keys.length){
      projList.innerHTML = '<div class="mut">No mapped projects yet.</div>';
      activeProject = null;
      return;
    }
    keys.forEach(k=>{
      const m = data[k];
      const btn = document.createElement('button');
      btn.className = 'proj';
      btn.textContent = m.display_name || m.project_name;
      btn.onclick = () => {
        [...projList.children].forEach(el=>el.classList.remove('active'));
        btn.classList.add('active');
        activeProject = m;
        addMsg(`(Active project: ${m.display_name || m.project_name})`, 'ai');
      };
      projList.appendChild(btn);
    });
  }catch(e){
    projList.innerHTML = '<div class="mut">Failed to load projects.</div>';
  }
}

/* ====== CHAT ====== */
async function askAI(){
  const text = q.value.trim();
  if(!text) return;
  addMsg(text,'me');
  q.value = '';
  addMsg('…thinking');
  try{
    const payload = { question: text };
    if (activeProject) payload.context = { activeProject };
    const res = await fetch(AI_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    chat.lastElementChild.innerHTML = md(data.text || 'No response.');
  }catch(e){
    chat.lastElementChild.innerHTML = md('Error: ' + e.message);
  }
}

send.addEventListener('click', askAI);
q.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); askAI(); }
});

/* ====== INIT ====== */
refreshProjects();
addMsg('مرحبًا بكم في **Diriyah AI** — أرسل سؤالك وسأجيب بإيجاز مع روابط مباشرة للمستندات ضمن "Sources:".\nWelcome to **Diriyah AI**. Connect storage, pick a project, and ask anything. I’ll answer briefly and include direct file links under “Sources:”.');

/* Optional: visually reflect connection state (stub) */
document.getElementById('gsvc-status').textContent = 'Connected to project files';
document.getElementById('msvc-status').textContent = 'Connect to Microsoft OneDrive';
</script>
</body>
</html>
