version: "3.9"

services:
  app:
    build: .
    container_name: diriyah_app
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    env_file: .env
    environment:
      # When running *behind Nginx* locally, the public URL is http://localhost
      # so the Google OAuth redirect must point here (and be added in Google Cloud).
      OAUTH_REDIRECT_URI: "http://localhost/drive/callback"
    expose:
      - "8000"
    volumes:
      # Mount the repo read-only inside the container (handy for quick local edits)
      - ./:/app:ro

  nginx:
    image: nginx:1.25-alpine
    container_name: diriyah_nginx
    depends_on:
      - app
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./static:/app/static:ro

  # -------- Optional: standalone ChromaDB (only if your main.py is set to use it) ------
  # chroma:
  #   image: chromadb/chromadb:0.5.5
  #   container_name: diriyah_chroma
  #   volumes:
  #     - chroma_data:/chroma
  #   ports:
  #     - "8001:8000"
  #   environment:
  #     - IS_PERSISTENT=TRUE
  # --------------------------------------------------------------------------------------

volumes:
  chroma_data:
