import os
import chromadb
from chromadb.utils import embedding_functions
import logging

# ========= Logging =========
log = logging.getLogger("index")
logging.basicConfig(level=logging.INFO)

# ========= Environment =========
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# ========= ChromaDB Setup =========
chroma_client = chromadb.PersistentClient(path="/data/chroma")

embedding_fn = embedding_functions.OpenAIEmbeddingFunction(
    api_key=OPENAI_API_KEY,
    model_name="text-embedding-3-small"
)

collection = chroma_client.get_or_create_collection(
    name="diriyah_ai",
    embedding_function=embedding_fn
)

# ========= Log Buffer =========
_index_log = []

def log_event(message: str):
    """Append to in-memory log + console"""
    log.info(message)
    _index_log.append(message)
    if len(_index_log) > 100:
        _index_log.pop(0)

# ========= Index Functions =========
def add_documents(docs: list[str], metadatas: list[dict] = None, ids: list[str] = None):
    """Add documents to Chroma collection"""
    try:
        collection.add(documents=docs, metadatas=metadatas, ids=ids)
        log_event(f"Indexed {len(docs)} docs")
    except Exception as e:
        log.exception("Error adding documents")
        log_event(f"Error indexing: {e}")
        raise

def query_documents(query: str, n_results: int = 3):
    """Query indexed docs"""
    try:
        res = collection.query(query_texts=[query], n_results=n_results)
        log_event(f"Query: {query} â†’ {len(res['documents'][0])} results")
        return res
    except Exception as e:
        log.exception("Query error")
        log_event(f"Query error: {e}")
        return {"documents": [], "metadatas": [], "ids": []}

def get_index_count():
    """Return count of chunks (compatible across ChromaDB versions)"""
    try:
        try:
            return collection.count()
        except AttributeError:
            return len(collection.get()["ids"])
    except Exception as e:
        log.exception("Count error")
        return 0

def get_logs(n: int = 10):
    """Return last N log entries"""
    return _index_log[-n:]

