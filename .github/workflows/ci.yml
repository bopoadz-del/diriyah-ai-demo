name: CI

on:
  push:
    branches: ["*"]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pip-audit
      - name: Run pip-audit
        run: pip-audit -r requirements.txt
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci
      - name: Run npm audit (frontend)
        working-directory: frontend
        run: npm audit --audit-level=high
      - name: Run pytest
        run: pytest -q

  frontend-audit:
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      - name: Run npm audit (frontend)
        run: |
          cd frontend
          # Run npm audit and only fail on high/critical vulnerabilities
          exit_code=0
          npm audit --audit-level=high || exit_code=$?
          if [ "${exit_code}" != "0" ]; then
            echo "❌ High or critical vulnerabilities found!"
            exit ${exit_code}
          fi
          echo "✅ No high or critical vulnerabilities found"

  helm-lint-and-package:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4
      - name: Helm lint
        run: helm lint helm/diriyah-brain-ai
      - name: Helm template
        run: helm template test-release helm/diriyah-brain-ai

  request-prod-approval:
    needs: [build-and-test, frontend-audit, helm-lint-and-package]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Post Slack Approval Message
        env:
          CHANNEL: ${{ secrets.SLACK_APPROVAL_CHANNEL }}
          TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          COMMIT_SHA=${GITHUB_SHA}
          curl -X POST -H "Authorization: Bearer $TOKEN" -H 'Content-type: application/json' \
          --data "{
            \"channel\": \"$CHANNEL\",
            \"text\": \"⏳ Prod deployment awaiting approval for commit $COMMIT_SHA\",
            \"attachments\": [{\n            ...
